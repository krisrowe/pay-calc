# Pay Stub Data Extraction and YTD Calculation

This project manages pay stub data extraction, storage, and year-to-date (YTD) calculations for tax projection purposes.

## Overview

Pay stubs are extracted from PDF files and stored in year-based JSON files (`YYYY_pay_stubs.json`). The YTD numbers from the latest pay stub for each employer are used as the source of truth for tax calculations, as they represent the cumulative totals up to that point in the year.

## Key Concepts

### Current vs YTD Numbers

- **Current**: The amount for the specific pay period shown on the stub
- **YTD (Year-To-Date)**: The cumulative total from the beginning of the year through the pay date

### Source of Truth Logic

When multiple pay stubs exist for the same employer on the same pay date (e.g., a regular pay stub and a bonus stub), the stub with the **largest YTD numbers** is the source of truth, as it is inclusive of all payments up to that date.

**Example**: On 2025-11-07, there were two Employer A LLC stubs:
- Regular Pay Stub: YTD Gross = $35,000.00
- Recognition Bonus Stub: YTD Gross = $35,000.00

The Recognition Bonus stub had the larger YTD, making it the source of truth for Employer A LLC as of that date.

### Field Relevance

- **YTD numbers** are the primary data used for tax projections and W-2 equivalent calculations
- **Current numbers** are useful for:
  - Projecting future payments when a stub represents a typical pay period
  - Understanding the breakdown of a specific payment
  - Validating that YTD numbers are cumulative

## File Structure

### Directory Organization

- `stubs/` - Contains all pay stub PDF files
- `data/` - Contains all generated JSON files:
  - `YYYY_party_pay_stubs.json` - Extracted pay stub data for a specific year and party (him/her)
  - `YYYY_party_ytd.json` - Calculated YTD totals for a specific year and party (him/her)
- `config.yaml` - Configuration file defining employers, party (him/her), and processors

### `config.yaml`

Configuration file that defines:
- **Employers**: Each employer entry includes:
  - `name`: Employer name
  - `party`: Either "him" or "her" to identify which person the pay stub belongs to
  - `processor`: The processor type to use for this employer's pay stub format
  - `file_patterns`: List of patterns to match in the PDF filename
  - `content_patterns`: List of patterns to match in the PDF content
  - `default_location`: Optional default location metadata

Example:
```yaml
employers:
  - name: "Employer A LLC"
    party: "him"
    processor: "google_llc"
    file_patterns:
      - "Employer A LLC"
    content_patterns:
      - "Employer A LL C"
```

### `YYYY_party_pay_stubs.json`

Contains extracted pay stub data for a specific year and party (him/her) with the following structure:

```json
{
  "pay_stubs": [
    {
      "file_name": "filename.pdf",
      "employer": "Employer Name",
      "party": "him",
      "processor": "google_llc",
      "pay_date": "YYYY-MM-DD",
      "period": {
        "start": "YYYY-MM-DD",
        "end": "YYYY-MM-DD"
      },
      "document_id": "document_number",
      "net_pay": 1234.56,
      "earnings": [
        {
          "type": "Regular Pay",
          "current_amount": 1234.56,
          "ytd_amount": 50000.00
        }
      ],
      "taxes": {
        "federal_income_tax": {
          "taxable_wages": 1234.56,
          "current_withheld": 200.00,
          "ytd_withheld": 8000.00
        },
        "social_security": {
          "taxable_wages": 1234.56,
          "current_withheld": 76.54,
          "ytd_withheld": 3000.00
        },
        "medicare": {
          "taxable_wages": 1234.56,
          "current_withheld": 17.90,
          "ytd_withheld": 700.00
        }
      },
      "deductions": [
        {
          "type": "401K Pretax",
          "current_amount": 0.00,
          "ytd_amount": 23500.00,
          "employer_match_ytd": 11750.00
        }
      ],
      "pay_summary": {
        "current": {
          "gross": 1234.56,
          "fit_taxable_wages": 1200.00,
          "taxes": 294.44,
          "deductions": 100.00,
          "net_pay": 840.12
        },
        "ytd": {
          "gross": 50000.00,
          "fit_taxable_wages": 48000.00,
          "taxes": 12000.00,
          "deductions": 5000.00,
          "net_pay": 33000.00
        }
      }
    }
  ]
}
```

### `YYYY_ytd.json`

Generated by `calc_ytd.py`, contains aggregated YTD totals by employer and grand totals for the year. Structure:

```json
{
  "year": 2025,
  "employers": {
    "Employer A LLC": {
      "earnings": {
        "regular_pay": 23456.78,
        "bonuses": 10000.00,
        "stock_units": 19137.07,
        "total_gross": 52593.85
      },
      "taxes": {
        "federal_income_tax_withheld": 10773.11,
        "social_security_withheld": 3203.00,
        "medicare_withheld": 749.09,
        "total_taxes": 14725.20
      },
      "deductions": {
        "401k_pretax": 0.00,
        "401k_after_tax": 6266.68,
        "health_insurance": 680.13,
        "total_deductions": 19600.31
      },
      "fit_taxable_wages": 51661.28,
      "source_stub": "2025 Q3 Sales Bonus Pay Stub on 11-21.pdf",
      "source_pay_date": "2025-11-21"
    }
  },
  "totals": {
    "earnings": {
      "total_gross": 361564.75
    },
    "taxes": {
      "federal_income_tax_withheld": 73505.27,
      "social_security_withheld": 14121.20,
      "medicare_withheld": 6020.21,
      "total_taxes": 93646.68
    },
    "deductions": {
      "total_deductions": 160333.77
    },
    "fit_taxable_wages": 368832.73
  }
}
```

## Scripts

### `extract_pay_stub.py`

Extracts pay stub data from a PDF file and adds/updates `pay_stub_data.json`.

**Usage:**
```bash
python3 extract_pay_stub.py "stubs/pay_stub.pdf"
```

**Year and Party Detection:**
- The script automatically determines the year from the pay date in the PDF
- The party (him/her) is determined from `config.yaml` based on employer identification
- Pay stubs are stored in `data/YYYY_party_pay_stubs.json` based on the year and party

**Deduplication Logic:**
- If a pay stub with identical YTD numbers already exists in the year and party's file, the script will skip importing it
- This prevents duplicate entries when the same PDF is processed multiple times
- Duplicates are checked based on employer, party, and YTD numbers

**Output:**
- Updates `data/YYYY_party_pay_stubs.json` with the new or updated pay stub entry
- Creates a timestamped backup file before updating
- Prints confirmation message indicating whether the stub was added or skipped

**Batch Processing:**
- Can process a single PDF file: `python3 extract_pay_stub.py stubs/file.pdf`
- Can process all PDFs in stubs directory: `python3 extract_pay_stub.py stubs/`
- Can filter by year: `python3 extract_pay_stub.py stubs/ 2025`

### `calc_ytd.py`

Calculates YTD totals by employer from `YYYY_party_pay_stubs.json` files and generates `YYYY_party_ytd.json`.

**Usage:**
```bash
python3 calc_ytd.py [year] [party]
```

- If year is not specified, defaults to the current year
- If party is not specified, processes both him and her separately
- Party must be either "him" or "her"

**Process Logic:**

1. **Load all pay stubs** from `data/YYYY_party_pay_stubs.json` for the specified year and party (or both parties if not specified)

2. **Group by employer and party** - All pay stubs are grouped by employer name and party

3. **Find latest YTD for each employer:**
   - For each employer, compare all pay stubs
   - When multiple stubs have the same pay date, compare YTD gross amounts
   - The stub with the **largest YTD gross** is the source of truth (it's inclusive of all payments)
   - This handles cases where regular pay and bonus stubs are issued on the same date

4. **Aggregate earnings:**
   - Sum all earnings types (Regular Pay, Bonuses, Stock Units, etc.)
   - Calculate total gross earnings

5. **Aggregate taxes:**
   - Sum federal income tax withheld
   - Sum social security tax withheld
   - Sum medicare tax withheld
   - Calculate total taxes

6. **Aggregate deductions:**
   - Sum all deduction types
   - Track 401k pre-tax and after-tax separately if needed

7. **Calculate grand totals:**
   - Sum all employer totals to get year-end totals
   - These represent W-2 equivalent numbers

8. **Generate JSON output:**
   - Create `data/YYYY_party_ytd.json` with employer breakdowns and totals for each party
   - If both parties are processed, shows combined totals at the end
   - Include source stub information for traceability

**Examples:**
```bash
# Process both him and her for 2025
python3 calc_ytd.py 2025

# Process only him for 2025
python3 calc_ytd.py 2025 him

# Process only her for 2025
python3 calc_ytd.py 2025 her
```

This generates `data/2025_him_ytd.json` and/or `data/2025_her_ytd.json` with YTD totals.

## Workflow

1. **Place pay stub PDF in stubs folder:**
   ```bash
   cp "path/to/pay_stub.pdf" stubs/
   ```

2. **Extract new pay stub:**
   ```bash
   python3 extract_pay_stub.py "stubs/2025-12-05 Regular Pay Stub.pdf"
   ```

3. **Calculate YTD totals:**
   ```bash
   python3 calc_ytd.py 2025
   ```

4. **Use YTD data for tax projections:**
   - The `data/YYYY_party_ytd.json` files contain the W-2 equivalent numbers for each party
   - Combine both files for joint tax return calculations
   - Use these in tax projection spreadsheets or calculations

## Notes

- PDF extraction may be unreliable due to format inconsistencies across different pay stub formats
- If `extract_pay_stub.py` fails to reliably extract data, manual entry into `data/YYYY_party_pay_stubs.json` may be necessary
- Always verify extracted numbers against the PDF source
- The YTD comparison logic ensures we capture the most complete data when multiple stubs exist for the same date
- Pay stubs are organized by year to keep files manageable and make it easier to work with specific tax years
- The `party` field (him/her) allows the system to distinguish between pay stubs for different people in the same household
- Employer identification uses both filename patterns and content patterns from `config.yaml` for maximum flexibility

## Dependencies

- Python 3.x
- PyPDF2 - For PDF text extraction
- PyYAML - For reading config.yaml

Install dependencies:
```bash
pip install PyPDF2 PyYAML
```

## Field Mapping to W-2

The YTD totals in `YYYY_party_ytd.json` map to W-2 fields as follows:

- **W-2 Box 1 (Wages)**: `fit_taxable_wages` (after pre-tax deductions)
- **W-2 Box 2 (Federal Tax)**: `taxes.federal_income_tax_withheld`
- **W-2 Box 3 (SS Wages)**: Social Security taxable wages (capped at $168,600 for 2025)
- **W-2 Box 4 (SS Tax)**: `taxes.social_security_withheld`
- **W-2 Box 5 (Medicare Wages)**: Medicare taxable wages (no cap)
- **W-2 Box 6 (Medicare Tax)**: `taxes.medicare_withheld`


{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pay-calc/schemas/stub.json",
  "title": "Pay Stub Record",
  "description": "Canonical schema for pay stub records. Enforces consistent field names across all extraction methods.",
  "type": "object",
  "required": ["pay_date", "employer", "taxes", "pay_summary"],
  "additionalProperties": false,
  "properties": {
    "pay_date": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
      "description": "Pay date in YYYY-MM-DD format"
    },
    "employer": {
      "type": "string",
      "minLength": 1
    },
    "net_pay": {
      "type": ["number", "null"]
    },
    "document_id": {
      "type": ["string", "null"]
    },
    "file_name": {
      "type": ["string", "null"]
    },
    "period": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "start": { "type": ["string", "null"] },
        "end": { "type": ["string", "null"] }
      }
    },
    "pay_summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ytd"],
      "properties": {
        "current": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "gross": { "type": ["number", "null"] },
            "taxes": { "type": ["number", "null"] },
            "deductions": { "type": ["number", "null"] },
            "net_pay": { "type": ["number", "null"] },
            "fit_taxable_wages": { "type": ["number", "null"] }
          }
        },
        "ytd": {
          "type": "object",
          "additionalProperties": false,
          "required": ["gross"],
          "properties": {
            "gross": { "type": "number", "exclusiveMinimum": 0, "description": "YTD gross must be positive for W-2 generation" },
            "taxes": { "type": ["number", "null"] },
            "deductions": { "type": ["number", "null"] },
            "net_pay": { "type": ["number", "null"] },
            "fit_taxable_wages": { "type": ["number", "null"] }
          }
        }
      }
    },
    "taxes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["federal_income_tax", "social_security", "medicare"],
      "properties": {
        "federal_income_tax": { "$ref": "#/$defs/tax_entry_required" },
        "social_security": { "$ref": "#/$defs/tax_entry_required" },
        "medicare": { "$ref": "#/$defs/tax_entry_required" },
        "state": { "$ref": "#/$defs/tax_entry" }
      },
      "not": {
        "anyOf": [
          { "required": ["federal_income"] },
          { "required": ["federal"] }
        ]
      }
    },
    "earnings": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["type"],
        "properties": {
          "type": { "type": "string" },
          "current_amount": { "type": ["number", "null"] },
          "ytd_amount": { "type": ["number", "null"] }
        }
      }
    },
    "deductions": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["type"],
        "properties": {
          "type": { "type": "string" },
          "current_amount": { "type": ["number", "null"] },
          "ytd_amount": { "type": ["number", "null"] },
          "employer_match_ytd": { "type": ["number", "null"] }
        }
      }
    }
  },
  "$defs": {
    "tax_entry": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "properties": {
        "taxable_wages": { "type": ["number", "null"] },
        "current_withheld": { "type": ["number", "null"] },
        "ytd_withheld": { "type": ["number", "null"] }
      },
      "not": {
        "anyOf": [
          { "required": ["current"] },
          { "required": ["ytd"] }
        ]
      }
    },
    "tax_entry_required": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ytd_withheld"],
      "properties": {
        "taxable_wages": { "type": ["number", "null"] },
        "current_withheld": { "type": ["number", "null"] },
        "ytd_withheld": { "type": "number", "minimum": 0, "description": "YTD withholding (can be $0 when maxing 401k)" }
      },
      "not": {
        "anyOf": [
          { "required": ["current"] },
          { "required": ["ytd"] }
        ]
      }
    }
  }
}
